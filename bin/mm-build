#!/usr/bin/env ruby

ENV['MM_ENV'] = "build"

# Require app
require File.join(File.dirname(__FILE__), "..", "lib", "middleman")
require 'middleman/builder'

# Middleman::Server.init!
Middleman::Builder.init!

# Hack to copy sprite images before sass runs
require 'fileutils'
FileUtils.cp_r(File.join(Dir.pwd, 'public/images'), File.join(Dir.pwd, 'build'))

Middleman::Generators.run_cli(Dir.pwd, 'mm-build', 1,  %w(build --force).concat(ARGV))

# Hack to change lemonade sprite urls to relative
filename = File.join(Dir.pwd, 'build/stylesheets/site.css')
File.open(filename) do |source|
  @result = source.read.gsub('/images', 'images')
end
FileUtils.rm_f(filename)
File.open(filename, 'w') do |f|
  f.write(@result)
end
